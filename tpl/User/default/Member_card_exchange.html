<include file="Public:head"/>  
<link rel="stylesheet" href="/js/kindeditor/themes/default/default.css" />
<link rel="stylesheet" href="/js/kindeditor/plugins/code/prettify.css" />
<link rel="stylesheet" type="text/css" href="/themes/a/css/shop.css" />
<script src="/js/kindeditor/kindeditor.js" type="text/javascript"></script>
<script src="/js/kindeditor/lang/zh_CN.js" type="text/javascript"></script>
<script src="/js/kindeditor/plugins/code/prettify.js" type="text/javascript"></script>
<script src="{lingzh::RES}/js/date/WdatePicker.js"></script>  
<script>
var editor;
KindEditor.ready(function(K) {
	editor = K.create('#info', {
		resizeType : 1,
		allowPreviewEmoticons : false,
		allowImageUpload : true,
		items : [
			'source','undo','redo','copy','plainpaste','wordpaste','clearhtml','quickformat','selectall','fullscreen','fontname', 'fontsize','subscript','superscript','indent','outdent','|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline','hr',
			 '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist', 'multiimage',
			'insertunorderedlist','link', 'unlink',''],
		afterBlur: function(){
			this.sync();
		}
	});
});

var editor;
KindEditor.ready(function(K) {
	editor = K.create('#info2', {
		resizeType : 1,
		allowPreviewEmoticons : false,
		allowImageUpload : false,
		items : [
			'source','undo','redo','copy','plainpaste','wordpaste','clearhtml','quickformat','selectall','fullscreen','fontname', 'fontsize','subscript','superscript','indent','outdent','|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline','hr',
			 '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist', 'multiimage',
			'insertunorderedlist','link', 'unlink',''],
		afterBlur: function(){
			this.sync();
		}
	});
});
</script>
<style>
	#qiandao .con-group {
		display: none;
	}
</style>

<div class="content">
  <div class="cLineB"> 
    <div class="clr"></div>
  </div>
  <!--tab start-->
  <div class="tab">
    <ul>
      <li class="tabli" id="tab0"><a href="{lingzh::U('Membership/img')}">会员卡图文消息</a></li>
      <li class="tabli" id="tab3"><a href="{lingzh::U('Member_card/info')}">商家信息设置</a></li>
      <li class="tabli" id="tab1"><a href="{lingzh::U('Member_card/index')}">卡片设计</a></li>
      <li class="tabli" id="tab4"><a href="{lingzh::U('Member/setmemberinfo')}">会员资料设置</a></li>
      <li class="tabli" id="tab5"><a href="{lingzh::U('Member/setclassinfo')}">自定义会员等级</a></li>
      <li class="current tabli" id="tab6"><a href="{lingzh::U('Member_card/exchange')}">积分规则设置</a></li>
    </ul>
  </div>
  <!--tab end-->

  <div class="cLineB"> 
    <div class="clr"></div>
  </div>
	<form method="post" action="" id="qiandao" >
	   <div class="msgWrap form">
			 <table class="ListProduct" border="0" cellspacing="0" cellpadding="0" width="100%">
				<thead>
					<tr>
						<th width="15%">会员动作</th>
						<th>奖励积分</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>消费1元</td>
						<td><input type="text" name="reward" class="px" value="{lingzh:$exchange.reward}" style="width:60px;"></td>
					</tr>
					<!--<tr>
						<td>每天签到</td>
						<td><input type="text" name="everyday" class="px" value="{lingzh:$exchange.everyday}" style="width:60px;"></td>
					</tr>
					<tr>
						<td>连续6天签到</td>
						<td><input type="text" name="continuation" value="{lingzh:$exchange.continuation}" class="px" style="width:60px;"></td>
					</tr>
                    <!--
                    <tr>
						<td>积分有效期</td>
						<td><input type="text" name="expire" class="px" value="<?php
                        /*
                     if(!empty($list['add_expend_time'])):
                      echo date('Y-m-d',$list['add_expend_time']);
                      else:
                         echo date('Y-m-d',time());
                      endif;
                      */
                   ?>" style="width:90px;" onClick="WdatePicker()"></td>
						<td></td>
					</tr>	
                        -->
                   <tr>
						<td>
							<div>
								类型&nbsp;&nbsp;<select name="type" id="">
									<option value="1" <if condition="$exchange.type eq 1">selected</if> >级跃</option>
									<option value="2" <if condition="$exchange.type eq 2">selected</if> >累加</option>
									<option value="3" <if condition="$exchange.type eq 3">selected</if> >累加+级跃 </option>
								</select>
							</div>
						</td>
						<td>
							<div class="con-group start-group" style="width:190px; float:left;">
								<label for="">每天签到</label>
								<input type="text" name="start" class="px" value="{lingzh:$exchange.start|default = '1'}">
							</div>
							<div class="con-group step-group" style="width:190px; float:left;">
								<label for="">积分增长率</label>
								<input type="text" name="step" class="px"  value="{lingzh:$exchange.step|default = ''}">
							</div>
							<div class="con-group limit-group" style="width:190px; float:left;">
								<label for="">积分最大限制</label>
								<input type="text" name="limit" class="px"  value="{lingzh:$exchange.limit|default = ''}">
							</div>
							<div class="con-group last-group" style="width:190px; float:left;">
								<label for="">最大签到天数限制</label>
								<input type="text" name="last" class="px" value="{lingzh:$exchange.last|default = ''}">
							</div>
							<div class="con-group prize-group" style="width:190px; float:left;">
								<label for="">最大签到天数奖励积分</label>
								<input type="text" name="prize" class="px" value="{lingzh:$exchange.prize|default = ''}">
							</div>
							<div class="con-group map"  style="width: 570px; padding-top:10px;float:left;">
								<table style="width:100%;">
									<thead>
										<tr class="title">
											<th>签到天数</th>
											<th>奖励积分</th>
											<th>操作</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
								<button class="add-row btnGray vm">添加一行</button>
							</div>
						</td>
					</tr>
					<tr style="display:none;">
						<td style="color:red;font-weight:bold;">说明</td>
						<td>
						</td>
					</tr>
				</tbody>
			 </table>
  	 </div>
  	<div class="msgWrap bgfc"> 
  		<table class="userinfoArea" style=" margin:0;" border="0" cellspacing="0" cellpadding="0" width="100%">
  			<tbody>
  				<tr>
  					<td valign="top" style="font-size:14px; line-height:30px;">签到积分规则说明：<br>
  						<textarea class="px" id="info" name="cardinfo" style="width: 400px; height: 200px; display: none;">{lingzh:$exchange.cardinfo}</textarea>
  					</td>
  				</tr>
  				<tr>
  					<td valign="top" style="font-size:14px; line-height:30px;">消费积分规则说明：<br>
  						<textarea class="px" id="info2" name="cardinfo2" style="width: 400px; height: 200px; display: none;">{lingzh:$exchange.cardinfo2}</textarea>
  					</td>
  				</tr>
  				<tr>
  					<td colspan="2">
  						<button type="submit" name="button" class="btnGreen">保存</button>　
  						<a href="javascript:history.go(-1);" class="btnGray vm">取消</a>
  					</td>
  				</tr>
  			</tbody>
  		</table>
  	</div> 
	</form>
</div>
<script type="text/javascript">
	$(function(){
		var $form = $("#qiandao");

		var json = '{lingzh:$exchange.config}' ? '{lingzh:$exchange.config}' : '{"map":{"":""}}' ;//'<?php echo $exchange["config"]; ?>';
		var jsonobj = $.parseJSON(json);
		
		function appendTr() {
			var trtem = '<tr><td><input name="keys[]" type="text" class="px" value=""></td><td><input name="values[]" type="text" class="px" value=""></td><td><button class="del-row btnGray">删除</button></td></tr>';
			$('.map tbody').append(trtem);
		}

		function renderMap(map) {
			var trtem = '<tr><td><input name="keys[]" type="text" class="px" value="{{key}}"></td><td><input name="values[]" type="text" class="px" value="{{value}}"></td><td><button class="del-row btnGray">删除</button></td><</tr>';
			var tr = '';
			//清空之前数据
			$('.map tbody').html('');
			if (!map) {
				tr = trtem.replace('{{key}}', '');
				tr = tr.replace('{{value}}', '');
				$('.map tbody').append(tr);
			}else{
				for(var key in map) {
					tr = trtem.replace('{{key}}', key);
					tr = tr.replace('{{value}}', map[key]);
					$('.map tbody').append(tr);
				}
			}
		}

		$form.on('click', '.del-row', function(e){
			e.preventDefault();
			if($form.find('.map tbody tr').length > 1) {
				$(e.currentTarget).parent().parent().remove();
			}
			return false;
		});

		$form.find('.add-row').on('click', function(e){
			e.preventDefault();
			appendTr();
			return false;
		});

		function switchQiandao(value) {
			if (value == 1) {
				$form.find('.con-group').hide();
				$(".start-group, .map, .last-group, .prize-group").show();
				if ('{lingzh:$exchange.type}' == '1') {
					if (typeof jsonobj.map == 'object') {
						renderMap(jsonobj.map);
					}else{
						renderMap();
					}
					$(".start-group").val(jsonobj.start ? jsonobj.start : '1');
					$(".last-group").val(jsonobj.last ? jsonobj.last : '');
					$(".prize-group").val(jsonobj.prize ? jsonobj.prize : '');
				}else{
					$(".start-group").val(1);
					$(".last-group").val('');
					$(".prize-group").val('');
					renderMap();
				}
			}else if (value == 2) {
				$form.find('.con-group').hide();
				$(".start-group, .step-group, .limit-group").show();
				if ('{lingzh:$exchange.type}' == '2') {
					$(".start-group .px").val(jsonobj.start ? jsonobj.start : '1');
					$(".step-group .px").val(jsonobj.step ? jsonobj.step : '');
					$(".limit-group .px").val(jsonobj.limit ? jsonobj.limit : '');
				}else{
					$(".start-group .px").val(1);
					$(".step-group .px").val('');
					$(".limit-group .px").val('');
					renderMap();
				}
			}else if (value == 3) {
				$form.find('.con-group').hide();
				$(".start-group, .step-group, .map, .limit-group").show();
				if ('{lingzh:$exchange.type}' == '3') {
					if (typeof jsonobj.map == 'object') {
						renderMap(jsonobj.map);
					}else{
						renderMap();
					}
					$(".start-group .px").val(jsonobj.start ? jsonobj.start : '1');
					$(".step-group .px").val(jsonobj.step ? jsonobj.step : '');
					$(".limit-group .px").val(jsonobj.limit ? jsonobj.limit : '');
				}else{
					$(".start-group .px").val(1);
					$(".step-group .px").val('');
					$(".limit-group .px").val('');
					renderMap();
				}
			}
		}

		if($form.find("select option:selected").length == 1) {
			var value = $form.find("select option:selected").val();
			switchQiandao(value);
		}

		$form.find("select").on('change', function(){
			var value = $(this).val();
			switchQiandao(value);
		});
	})
</script>
<include file="Public:footer"/>